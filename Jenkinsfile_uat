pipeline {
	agent any

	environment {
		// Application configuration
		APP_NAME = 'survey-app'

		// Application port
		APP_PORT = '5174'

		ADMIN_USERNAME = 'admin'
		ADMIN_PASSWORD = 'password'

		// AWS S3 configuration
		AWS_DEFAULT_REGION = 'ap-southeast-2'
		CLIENT_S3_BUCKET = 'uat.sigmaq.co'
		SUPER_ADMIN_S3_BUCKET = 'uat.sigmaq.co.admin'
	}

	stages {
		stage('Checkout') {
			steps {
				echo 'Checking out source code...'
				checkout scm
			}
		}

		stage('Build Client') {
			steps {
				echo 'Building client application...'
				dir('client') {
					sh '''
						echo "=== Installing client dependencies ==="
						npm install

						echo "=== Building client application ==="
						npm run build

						echo "=== Verifying build output ==="
						if [ -d "dist" ]; then
							echo "✓ Client build successful"
							ls -la dist/
						else
							echo "✗ Client build failed - dist directory not found"
							exit 1
						fi
					'''
				}
			}
		}

		stage('Build Super Admin') {
			steps {
				echo 'Building super admin application...'
				dir('super-admin') {
					sh '''
						echo "=== Installing super admin dependencies ==="
						npm install

						echo "=== Cleaning previous build ==="
						npm run clean || echo "No previous build to clean"

						echo "=== Building super admin application ==="
						npm run build

						echo "=== Verifying build output ==="
						if [ -d "dist" ]; then
							echo "✓ Super admin build successful"
							ls -la dist/
							
							# 验证关键文件
							if [ -f "dist/index.html" ]; then
								echo "✓ index.html found"
								echo "index.html content preview:"
								head -10 dist/index.html
							else
								echo "✗ index.html missing in build output"
								exit 1
							fi
							
							if [ -d "dist/assets" ]; then
								echo "✓ Assets directory found"
								echo "Assets contents:"
								ls -la dist/assets/
							else
								echo "✗ Assets directory missing"
								exit 1
							fi
						else
							echo "✗ Super admin build failed - dist directory not found"
							exit 1
						fi
					'''
				}
			}
		}

		stage('Deploy to S3') {
			steps {
				echo 'Deploying frontend applications to S3...'
				withVault([
					configuration: [
						timeout: 60,
						vaultCredentialId: 'Vault Credential',
						vaultUrl: 'https://vault.jiangren.com.au'
					],
					vaultSecrets: [[
						path: 'secret_aws/aws_uat',
						secretValues: [
							[vaultKey: 'AWS_ACCESS_KEY_ID'],
							[vaultKey: 'AWS_SECRET_ACCESS_KEY']
						]
					]]
				]) {
					script {
						parallel(
							'Deploy Client to S3': {
								dir('client') {
									sh '''
										echo "=== Deploying client to S3 ==="
										export AWS_ACCESS_KEY_ID="${AWS_ACCESS_KEY_ID}"
										export AWS_SECRET_ACCESS_KEY="${AWS_SECRET_ACCESS_KEY}"
										export AWS_DEFAULT_REGION="${AWS_DEFAULT_REGION}"

										# 验证构建文件完整性
										echo "=== Verifying client build artifacts ==="
										if [ ! -f "dist/index.html" ]; then
											echo "✗ Critical file dist/index.html is missing"
											exit 1
										fi
										
										echo "✓ Client build files verified"
										echo "Client build contents:"
										ls -la dist/

										# 创建备份（仅备份根目录文件，避免影响super-admin）
										echo "=== Creating backup of existing client deployment ==="
										aws s3 sync s3://${CLIENT_S3_BUCKET}/ s3://${CLIENT_S3_BUCKET}-backup-$(date +%Y%m%d-%H%M%S)/ --exclude "super-admin/*" || echo "No existing client deployment to backup"

										# 同步客户端文件（排除super-admin目录）
										aws s3 sync dist/ s3://${CLIENT_S3_BUCKET}/ --delete --exclude "super-admin/*"

										echo "=== Setting S3 website configuration ==="
										aws s3 website s3://${CLIENT_S3_BUCKET}/ --index-document index.html

										echo "=== Setting S3 bucket policy for public access ==="
										cat > bucket-policy.json << 'POLICY_EOF'
											{
												"Version": "2012-10-17",
												"Statement": [
													{
														"Sid": "PublicReadGetObject",
														"Effect": "Allow",
														"Principal": "*",
														"Action": "s3:GetObject",
														"Resource": "arn:aws:s3:::${CLIENT_S3_BUCKET}/*"
													}
												]
											}
											POLICY_EOF
										aws s3api put-bucket-policy --bucket ${CLIENT_S3_BUCKET} --policy file://bucket-policy.json || echo "Warning: Failed to set bucket policy"

										# 验证客户端部署结果
										echo "=== Verifying client deployment ==="
										if aws s3 ls s3://${CLIENT_S3_BUCKET}/index.html; then
											echo "✅ Client index.html successfully deployed"
										else
											echo "✗ Client index.html deployment failed"
											exit 1
										fi

										echo "✅ Client deployed successfully to S3"
									'''
								}
							},
							'Deploy Super Admin to S3': {
								dir('super-admin') {
									sh '''
										echo "=== Deploying super admin to main S3 bucket ==="
										export AWS_ACCESS_KEY_ID="${AWS_ACCESS_KEY_ID}"
										export AWS_SECRET_ACCESS_KEY="${AWS_SECRET_ACCESS_KEY}"
										export AWS_DEFAULT_REGION="${AWS_DEFAULT_REGION}"

										# 验证构建文件完整性
										echo "=== Verifying build artifacts ==="
										if [ ! -f "dist/index.html" ]; then
											echo "✗ Critical file dist/index.html is missing"
											exit 1
										fi
										
										if [ ! -d "dist/assets" ]; then
											echo "✗ Assets directory is missing"
											exit 1
										fi
										
										echo "✓ All critical files verified"
										echo "Build contents:"
										ls -la dist/

										# 安全部署：先备份现有文件，然后同步
										echo "=== Creating backup of existing deployment ==="
										aws s3 sync s3://${CLIENT_S3_BUCKET}/super-admin/ s3://${CLIENT_S3_BUCKET}/super-admin-backup-$(date +%Y%m%d-%H%M%S)/ || echo "No existing deployment to backup"

										# 部署到主S3 bucket的super-admin子目录（移除--delete以防止意外删除）
										echo "=== Syncing files to S3 ==="
										aws s3 sync dist/ s3://${CLIENT_S3_BUCKET}/super-admin/

										# 验证部署结果
										echo "=== Verifying deployment ==="
										if aws s3 ls s3://${CLIENT_S3_BUCKET}/super-admin/index.html; then
											echo "✅ index.html successfully deployed"
										else
											echo "✗ index.html deployment failed"
											exit 1
										fi

										echo "✅ Super admin deployed successfully to main S3 bucket"
									'''
								}
							}
						)
					}
				}
			}
		}
		stage('Build and Deploy Backend') {
			steps {
				echo 'Building and deploying backend service...'
				withVault([configuration: [ vaultUrl: 'https://vault.jiangren.com.au', vaultCredentialId: 'Vault Credential', timeout: 120],
					vaultSecrets: [
						[path: 'jr-survey/uat',
							secretValues: [
								[vaultKey: 'MONGO_URI'],
								[vaultKey: 'EMAIL_SERVICE_SQS_URL']
							]
						],
						[path: 'jenkins_jr_academy/uat',
							secretValues: [
								[vaultKey: 'AWS_ACCESS_KEY_ID'],
								[vaultKey: 'AWS_SECRET_ACCESS_KEY'],
								[vaultKey: 'AWS_REGION']
							]
						]
					]
				]) {
					script {
						echo "Environment variables loaded from Vault"
						echo "MONGO_URI: ${MONGO_URI}"

						// Use UAT compose file
						def composeFile = 'docker-compose.uat.yml'
						echo "Using compose file: ${composeFile}"

						withEnv(["COMPOSE_FILE=${composeFile}"]) {
							sh '''
								echo "=== Current Working Directory ==="
								pwd
								echo "=== File Listing ==="
								ls -la
								echo "=== Docker Compose Files Check ==="
								if [ -f "docker-compose.uat.yml" ]; then
									echo "✓ docker-compose.uat.yml exists"
								else
									echo "✗ docker-compose.uat.yml missing"
								fi
								echo "=== Key Files Check ==="
								if [ -f "server.js" ]; then
									echo "✓ server.js exists"
								else
									echo "✗ server.js missing"
								fi
								if [ -f "Dockerfile.uat" ]; then
									echo "✓ Dockerfile.uat exists"
								else
									echo "✗ Dockerfile.uat missing"
								fi

								# Create .env file with environment variables
								cat > .env << EOF
								MONGODB_URI=${MONGO_URI}
								PORT=5174
								NODE_ENV=uat
								ADMIN_USERNAME=${ADMIN_USERNAME}
								ADMIN_PASSWORD=${ADMIN_PASSWORD}
								EMAIL_SERVICE_SQS_URL=${EMAIL_SERVICE_SQS_URL}
								AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
								AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
								AWS_REGION=${AWS_REGION}
								EOF

								# Stop and remove existing survey containers
								docker-compose -f $COMPOSE_FILE down || true

								# Remove only survey-related images
								docker images | grep survey | awk '{print $3}' | xargs -r docker rmi -f || true

								# Clean up only dangling images (not used by any container)
								docker image prune -f

								echo "=== Starting Docker Containers ==="
								echo "Using compose file: $COMPOSE_FILE"

								# Build and start services
								docker-compose -f $COMPOSE_FILE up --build -d

								# Wait for services to start
								sleep 15

								# Check container status
								echo "=== Container Status ==="
								docker-compose -f $COMPOSE_FILE ps

								# Show logs if there are issues
								if ! docker-compose -f $COMPOSE_FILE ps | grep -q "Up"; then
									echo "=== Container Logs ==="
									docker-compose -f $COMPOSE_FILE logs
									exit 1
								fi
							'''
						}
					}
				}
			}
		}

		stage('Post-Deployment Health Check') {
			steps {
				echo 'Performing post-deployment health checks...'
				withVault([
					configuration: [
						timeout: 60,
						vaultCredentialId: 'Vault Credential',
						vaultUrl: 'https://vault.jiangren.com.au'
					],
					vaultSecrets: [[
						path: 'secret_aws/aws_uat',
						secretValues: [
							[vaultKey: 'AWS_ACCESS_KEY_ID'],
							[vaultKey: 'AWS_SECRET_ACCESS_KEY']
						]
					]]
				]) {
					script {
						sh '''
							echo "=== Post-Deployment Health Check ==="
							export AWS_ACCESS_KEY_ID="${AWS_ACCESS_KEY_ID}"
							export AWS_SECRET_ACCESS_KEY="${AWS_SECRET_ACCESS_KEY}"
							export AWS_DEFAULT_REGION="${AWS_DEFAULT_REGION}"

							# 检查客户端部署
							echo "=== Checking Client Deployment ==="
							if aws s3 ls s3://${CLIENT_S3_BUCKET}/index.html; then
								echo "✅ Client index.html exists"
							else
								echo "❌ Client index.html missing"
								exit 1
							fi

							# 检查Super Admin部署
							echo "=== Checking Super Admin Deployment ==="
							if aws s3 ls s3://${CLIENT_S3_BUCKET}/super-admin/index.html; then
								echo "✅ Super Admin index.html exists"
							else
								echo "❌ Super Admin index.html missing"
								exit 1
							fi

							# 检查关键资源文件
							echo "=== Checking Super Admin Assets ==="
							if aws s3 ls s3://${CLIENT_S3_BUCKET}/super-admin/assets/ | grep -q ".js"; then
								echo "✅ Super Admin JavaScript assets found"
							else
								echo "❌ Super Admin JavaScript assets missing"
								exit 1
							fi

							# 测试后端API连通性
							echo "=== Testing Backend API Connectivity ==="
							sleep 5  # 等待后端完全启动
							
							if curl -f -s --max-time 10 http://localhost:5174/api/health > /dev/null; then
								echo "✅ Backend API is responding"
							else
								echo "⚠️  Backend API not responding (this might be expected if health endpoint doesn't exist)"
							fi

							echo "=== Health Check Summary ==="
							echo "✅ All critical deployments verified successfully"
							echo "🌐 Client URL: https://${CLIENT_S3_BUCKET}.s3-website-${AWS_DEFAULT_REGION}.amazonaws.com"
							echo "🔧 Super Admin URL: https://${CLIENT_S3_BUCKET}.s3-website-${AWS_DEFAULT_REGION}.amazonaws.com/super-admin"
							echo "🚀 Backend API: http://localhost:5174/api"
						'''
					}
				}
			}
		}
	}

	post {
			always {
				echo 'Pipeline completed'
				cleanWs()
			}
			success {
				echo 'Deployment successful!'
				echo 'Access your applications at:'
				echo "  Backend API: http://localhost:5174/api"
				echo "  Client (S3): https://${CLIENT_S3_BUCKET}.s3-website-${AWS_DEFAULT_REGION}.amazonaws.com"
				echo "  Super Admin (S3): https://${SUPER_ADMIN_S3_BUCKET}.s3-website-${AWS_DEFAULT_REGION}.amazonaws.com"
				echo ""
				echo "UAT environment deployed successfully without CDN."
				// You can add notifications here (Slack, email, etc.)
			}
			failure {
				echo 'Deployment failed!'
				// You can add failure notifications here
			}
		}
}
