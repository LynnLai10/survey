services:
    mongodb:
        image: mongo:7.0
        restart: unless-stopped
        environment:
            MONGO_INITDB_DATABASE: survey
        volumes:
            - mongodb_data:/data/db
        logging:
            driver: 'json-file'
            options:
                max-size: '10m'
                max-file: '3'

    backend:
        build:
            context: .
            dockerfile: Dockerfile.backend
        env_file:
            - .env.docker
        environment:
            - MONGODB_URI=mongodb://mongodb:27017/survey
            - PORT=5050
            - NODE_ENV=production
            # AWS Email Service Configuration (from .env.docker)
            - EMAIL_SERVICE_SQS_URL=${EMAIL_SERVICE_SQS_URL}
            - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
            - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
            - AWS_REGION=${AWS_REGION:-ap-southeast-2}
        restart: unless-stopped
        depends_on:
            - mongodb
        healthcheck:
            test:
                - 'CMD-SHELL'
                - 'wget --no-verbose --tries=1 --spider http://localhost:5050/api/health || exit 1'
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 60s
        logging:
            driver: 'json-file'
            options:
                max-size: '10m'
                max-file: '3'
        volumes:
            - uploads:/app/uploads

    frontend:
        build:
            context: .
            dockerfile: Dockerfile.frontend
        ports:
            - '5051:5051'
        restart: unless-stopped
        depends_on:
            backend:
                condition: service_healthy

volumes:
    mongodb_data:
    uploads:
